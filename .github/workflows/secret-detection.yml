name: Secret Detection & Exploitation Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write
  security-events: write

jobs:
  # ============================================
  # JOB 1: Secret Detection
  # ============================================
  secret-detection:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    
    outputs:
      secrets-found: ${{ steps.check-results.outputs.secrets-found }}
      secret-count: ${{ steps.check-results.outputs.secret-count }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
      
      - name: Run Trivy Secret Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scanners: 'secret'
          severity: 'HIGH,CRITICAL'
          format: 'json'
          output: 'trivy-results.json'
        continue-on-error: true
      
      - name: Create Trivy custom config
        run: |
          cat > trivy-secret-config.yaml << 'EOF'
          secret:
            config:
              disable-allow-rules: true
              rules:
                - id: generic-api-key
                  category: general
                  title: Generic API Key
                  severity: HIGH
                  regex: '(?i)(api[_-]?key|apikey)\s*[=:]\s*["'']?([A-Z0-9_]{10,})["'']?'
                  keywords:
                    - API_KEY
                
                - id: database-password
                  category: general
                  title: Database Password
                  severity: CRITICAL
                  regex: '(?i)(db[_-]?password|password)\s*[=:]\s*["'']?([^\s"'']{8,})["'']?'
                  keywords:
                    - PASSWORD
                    - DB_PASSWORD
                
                - id: private-key
                  category: general
                  title: Private Key
                  severity: CRITICAL
                  regex: '-----BEGIN [A-Z ]+PRIVATE KEY-----'
                  keywords:
                    - PRIVATE KEY
          EOF
      
      - name: Run Trivy with custom rules
        run: |
          trivy fs . \
            --scanners secret \
            --secret-config trivy-secret-config.yaml \
            --format json \
            --output trivy-custom-results.json \
            || true
      
      - name: Check results
        id: check-results
        run: |
          SECRET_COUNT=$(jq '[.Results[]?.Secrets // [] | length] | add // 0' trivy-results.json)
          echo "secret-count=$SECRET_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$SECRET_COUNT" -gt 0 ]; then
            echo "secrets-found=true" >> $GITHUB_OUTPUT
            echo "::warning::Found $SECRET_COUNT secrets in repository!"
          else
            echo "secrets-found=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload scan results
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-results
          path: |
            trivy-results.json
            trivy-custom-results.json
          retention-days: 30

  # ============================================
  # JOB 2: Aggregation & Analysis
  # ============================================
  aggregation:
    name: Aggregate & Analyze Secrets
    runs-on: ubuntu-latest
    needs: secret-detection
    if: needs.secret-detection.outputs.secrets-found == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download scan results
        uses: actions/download-artifact@v4
        with:
          name: secret-scan-results
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Aggregate results
        run: |
          python << 'PYTHON_SCRIPT'
          import json
          from pathlib import Path
          from datetime import datetime
          
          # Load Trivy results
          trivy_data = json.loads(Path('trivy-results.json').read_text())
          
          secrets = []
          for result in trivy_data.get('Results', []):
              for secret in result.get('Secrets', []):
                  secrets.append({
                      'repository': '${{ github.repository }}',
                      'file': result.get('Target', 'unknown'),
                      'line': secret.get('StartLine', 0),
                      'title': secret.get('Title', 'Unknown'),
                      'severity': secret.get('Severity', 'UNKNOWN'),
                      'rule_id': secret.get('RuleID', 'unknown'),
                      'category': 'generic'
                  })
          
          # Create consolidated report
          report = {
              'metadata': {
                  'scan_date': datetime.now().isoformat(),
                  'total_secrets': len(secrets),
                  'repository': '${{ github.repository }}',
                  'branch': '${{ github.ref_name }}',
                  'commit': '${{ github.sha }}'
              },
              'secrets': secrets
          }
          
          Path('consolidated-secrets-report.json').write_text(json.dumps(report, indent=2))
          print(f"Consolidated {len(secrets)} secrets")
          PYTHON_SCRIPT
      
      - name: Upload consolidated report
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-report
          path: consolidated-secrets-report.json
          retention-days: 90

  # ============================================
  # JOB 3: Exploitation Simulation with LocalStack
  # ============================================
  exploitation-simulation:
    name: LocalStack Exploitation
    runs-on: ubuntu-latest
    needs: [secret-detection, aggregation]
    if: needs.secret-detection.outputs.secrets-found == 'true'
    
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: s3,ec2,iam,dynamodb
          DEBUG: 1
        options: >-
          --health-cmd "curl -f http://localhost:4566/_localstack/health || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download consolidated report
        uses: actions/download-artifact@v4
        with:
          name: consolidated-report
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: pip install boto3
      
      - name: Wait for LocalStack
        run: |
          echo "Waiting for LocalStack to be ready..."
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f http://localhost:4566/_localstack/health 2>/dev/null; then
              echo "LocalStack is ready!"
              break
            fi
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts - waiting..."
            sleep 2
          done
      
      - name: Run exploitation simulation
        env:
          LOCALSTACK_ENDPOINT: http://localhost:4566
        run: |
          python << 'PYTHON_SCRIPT'
          import json
          import boto3
          from pathlib import Path
          from datetime import datetime
          
          LOCALSTACK_ENDPOINT = "http://localhost:4566"
          
          print("=" * 70)
          print("EXPLOITATION SIMULATION (GitHub Actions + LocalStack)")
          print("=" * 70)
          
          # Load secrets
          report = json.loads(Path('consolidated-secrets-report.json').read_text())
          secrets = report.get('secrets', [])
          
          print(f"Loaded {len(secrets)} secrets")
          
          # Setup LocalStack environment
          print("\n[*] Setting up vulnerable AWS environment...")
          s3_client = boto3.client(
              's3',
              endpoint_url=LOCALSTACK_ENDPOINT,
              aws_access_key_id='test',
              aws_secret_access_key='test',
              region_name='us-east-1'
          )
          
          # Create test buckets with sensitive data
          test_buckets = [
              ('company-data-prod', 'customers.csv'),
              ('customer-backups', 'database-backup.sql'),
              ('financial-reports', 'revenue-2024.xlsx')
          ]
          
          for bucket_name, file_name in test_buckets:
              try:
                  s3_client.create_bucket(Bucket=bucket_name)
                  s3_client.put_object(
                      Bucket=bucket_name,
                      Key=file_name,
                      Body=f'CONFIDENTIAL: Sensitive data from {bucket_name}'
                  )
                  print(f"Created: {bucket_name}/{file_name}")
              except Exception as e:
                  print(f"  ! {bucket_name}: {str(e)}")
          
          # Simulate exploitation
          print("\n[ATTACK] Simulating credential exploitation...")
          
          buckets = s3_client.list_buckets()
          bucket_count = len(buckets.get('Buckets', []))
          
          print(f"BREACH: Accessed {bucket_count} S3 buckets")
          
          files_stolen = 0
          for bucket in buckets['Buckets']:
              bucket_name = bucket['Name']
              try:
                  objects = s3_client.list_objects_v2(Bucket=bucket_name)
                  if 'Contents' in objects:
                      for obj in objects['Contents']:
                          print(f"STOLEN: {bucket_name}/{obj['Key']}")
                          files_stolen += 1
              except:
                  pass
          
          # Save results
          results = {
              'timestamp': datetime.now().isoformat(),
              'secrets_tested': len(secrets),
              'exploitation_successful': True,
              'resources_accessed': bucket_count,
              'files_exfiltrated': files_stolen,
              'estimated_damage': 'HIGH - $1.5M to $10M',
              'ci_cd_environment': 'GitHub Actions + LocalStack'
          }
          
          Path('exploitation-results.json').write_text(json.dumps(results, indent=2))
          
          print("\n" + "=" * 70)
          print(f"EXPLOITATION SUMMARY")
          print("=" * 70)
          print(f"  Resources Accessed: {bucket_count}")
          print(f"  Files Stolen: {files_stolen}")
          print(f"  Estimated Damage: HIGH")
          print("=" * 70)
          PYTHON_SCRIPT
      
      - name: Upload exploitation results
        uses: actions/upload-artifact@v4
        with:
          name: exploitation-results
          path: exploitation-results.json
          retention-days: 90

  # ============================================
  # JOB 4: Create Security Issues
  # ============================================
  create-security-issues:
    name: Create Security Alert
    runs-on: ubuntu-latest
    needs: [secret-detection, exploitation-simulation]
    if: |
      needs.secret-detection.outputs.secrets-found == 'true' &&
      github.event_name != 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download reports
        uses: actions/download-artifact@v4
        with:
          pattern: '*'
          merge-multiple: true
      
      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Load consolidated report
            const report = JSON.parse(fs.readFileSync('consolidated-secrets-report.json', 'utf8'));
            const secrets = report.secrets || [];
            
            // Load exploitation results
            let exploitResults = {};
            try {
              exploitResults = JSON.parse(fs.readFileSync('exploitation-results.json', 'utf8'));
            } catch (e) {
              console.log('No exploitation results found');
            }
            
            const issueBody = `
            ## SECURITY ALERT: Secrets Detected in Repository
            
            **Scan Date:** ${report.metadata.scan_date}
            **Branch:** ${report.metadata.branch}
            **Commit:** \`${report.metadata.commit.substring(0, 7)}\`
            
            ### Summary
            
            - **Total Secrets Found:** ${secrets.length}
            - **Repository:** ${report.metadata.repository}
            
            ${exploitResults.exploitation_successful ? `
            ### Exploitation Simulation Results (LocalStack)
            
            A simulated attack was performed to demonstrate impact:
            - **Resources Accessed:** ${exploitResults.resources_accessed}
            - **Files Exfiltrated:** ${exploitResults.files_exfiltrated}
            - **Estimated Damage:** ${exploitResults.estimated_damage}
            ` : ''}
            
            ### Detected Secrets
            
            | File | Line | Type | Severity |
            |------|------|------|----------|
            ${secrets.slice(0, 10).map(s => 
              `| \`${s.file}\` | ${s.line} | ${s.title} | ${s.severity} |`
            ).join('\n')}
            ${secrets.length > 10 ? `\n*... and ${secrets.length - 10} more*` : ''}
            
            ### IMMEDIATE ACTIONS REQUIRED
            
            1. **ROTATE ALL CREDENTIALS** - Generate new secrets immediately
            2. **REVOKE OLD SECRETS** - Invalidate all exposed credentials
            3. **REMOVE FROM CODE** - Delete hardcoded secrets from repository
            4. **USE SECRET MANAGER** - Store secrets in environment variables
            5. **REVIEW ACCESS LOGS** - Check for unauthorized access
            
            ### Remediation Checklist
            
            - [ ] All credentials rotated
            - [ ] Old credentials revoked
            - [ ] Secrets removed from code
            - [ ] Environment variables configured
            - [ ] Access logs reviewed
            - [ ] Team notified
            
            ### Resources
            
            - [Download Full Report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            - [GitHub Secret Scanning](https://docs.github.com/en/code-security/secret-scanning)
            
            ---
            *Automatically created by Secret Detection Pipeline*
            *Run ID: ${context.runId}*
            `;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `SECURITY: ${secrets.length} Secrets Detected - Immediate Action Required`,
              body: issueBody,
              labels: ['security', 'critical', 'secrets']
            });

  # ============================================
  # JOB 5: Block PR if Secrets Found
  # ============================================
  block-pr:
    name: Block PR with Secrets
    runs-on: ubuntu-latest
    needs: secret-detection
    if: |
      github.event_name == 'pull_request' &&
      needs.secret-detection.outputs.secrets-found == 'true'
    
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const secretCount = '${{ needs.secret-detection.outputs.secret-count }}';
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## SECRETS DETECTED - PR BLOCKED
              
              This pull request contains **${secretCount} exposed secrets** and cannot be merged.
              
              ### Required Actions:
              
              1. Remove all hardcoded secrets
              2. Use environment variables
              3. Update commits
              4. Re-run checks
              
              Workflow: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              `
            });
      
      - name: Fail the check
        run: |
          echo "::error::Secrets detected in pull request!"
          exit 1